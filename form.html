<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>タンブラー レイアウトプレビュー（無料メール送信対応）</title>
  <meta name="viewport" content="width=350,initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #f6f7fa;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container { max-width: 400px; margin: 40px auto; background: #fff; padding: 2em 1.5em; border-radius: 12px; box-shadow: 0 4px 24px #aaa2; text-align: center; }
    .note { font-size: 0.9em; color: #888; margin-top: 8px; }
    textarea { width: 95%; border-radius: 8px; font-size: 1em; margin: 0.5em 0; }
    .ctrl-btn, .reset-btn { margin-top: 0.3em; }
    #save-btn { margin-bottom: 1em; padding: 0.4em 1.2em; border-radius: 8px; background: #9ec9e8; color: #233; border: 1px solid #bbb; cursor: pointer; }
    #save-btn:active { background: #7fb7da; }
    canvas { display: block; margin: 0 auto 10px auto; border-radius: 16px; box-shadow: 0 0 8px #aaa; background: #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h2>タンブラー レイアウトプレビュー</h2>
    <canvas id="tumbler-canvas" width="260" height="400"></canvas>
    <!-- 画像を保存ボタン -->
    <div style="margin:1em 0;">
      <button id="save-btn" title="プレビュー画像を保存">画像を保存</button>
    </div>
    <!-- メール送信フォーム -->
    <form id="contact-form" action="https://formspree.io/f/mvgrnnpp" method="POST">
      <textarea id="bikou" name="message" rows="3" placeholder="備考欄：ご要望や連絡先等" required></textarea>
      <input type="hidden" name="_subject" value="タンブラー彫刻">
      <input type="hidden" name="_replyto" value="ryuji.hirashiki@gmail.com">
      <button type="submit" class="reset-btn" style="background:#379;color:#fff;">完了</button>
    </form>
    <label>
      レイアウト画像を選択　
      <input type="file" id="image-upload" accept="image/*">
    </label>
    <div class="note">
      ※「完了」ボタンで備考欄の内容のみ送信されます。<br>
      ※「画像を保存」でプレビュー画像を保存→ご自身でメール添付してください。<br>
      <b>※画像の自動添付メール送信は無料ではできません。</b>
    </div>
  </div>
  <script>
    // テンプレート画像のパス（必ずHTMLと同じ場所に！）
    const tumblerImgSrc = "67a9bd50-6f8c-48f9-9556-dff30c898654.png";
    const canvas = document.getElementById("tumbler-canvas");
    const ctx = canvas.getContext("2d");
    let tumblerImg = new Image();
    let tDraw = { x: 0, y: 0, w: 0, h: 0 };
    let userImg = null;
    let userPos = { x: 0, y: 0, scale: 1 };
    let defaultPos = { x: 0, y: 0, scale: 1 };

    // テンプレ画像をcanvas中央・縦横比維持で描画
    function calcTumblerDrawInfo() {
      const cW = canvas.width, cH = canvas.height;
      const iW = tumblerImg.width, iH = tumblerImg.height;
      const scale = Math.min(cW / iW, cH / iH);
      const drawW = iW * scale;
      const drawH = iH * scale;
      const offsetX = (cW - drawW) / 2;
      const offsetY = (cH - drawH) / 2;
      tDraw = { x: offsetX, y: offsetY, w: drawW, h: drawH };
    }
    function resetUserPos() {
      if (!userImg) return;
      const imgW = 160;
      const imgH = 160 * (userImg.height / userImg.width);
      const x = tDraw.x + (tDraw.w - imgW) / 2;
      const y = tDraw.y + (tDraw.h - imgH) / 2 + 30;
      userPos = { x: x, y: y, scale: 1 };
      defaultPos = { ...userPos };
    }
    function drawAll() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      calcTumblerDrawInfo();
      ctx.drawImage(tumblerImg, tDraw.x, tDraw.y, tDraw.w, tDraw.h);
      if (userImg) {
        const baseW = 160 * userPos.scale;
        const baseH = (160 * (userImg.height / userImg.width)) * userPos.scale;
        ctx.globalAlpha = 0.92;
        ctx.drawImage(userImg, userPos.x, userPos.y, baseW, baseH);
        ctx.globalAlpha = 1.0;
      }
    }

    // テンプレ画像のロード
    tumblerImg.onload = () => { drawAll(); };
    tumblerImg.src = tumblerImgSrc;

    // 画像保存ボタン
    document.getElementById('save-btn').onclick = function() {
      const a = document.createElement('a');
      a.href = canvas.toDataURL("image/png");
      a.download = "tumbler_layout.png";
      a.click();
    };

    // アップロード画像処理
    document.getElementById('image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        userImg = new Image();
        userImg.onload = () => {
          calcTumblerDrawInfo();
          resetUserPos();
          drawAll();
        };
        userImg.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    // ※必要に応じて移動・拡大縮小・ドラッグ等のJSも追加
  </script>
</body>
</html>
